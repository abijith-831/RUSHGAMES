<%-include('../layouts/header.ejs')%>
<%-include('../layouts/navbar.ejs')%>


<style>
    body {
        
        color: #1a202c;
        text-align: left;
       
    }

    
    .card {
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, .1), 0 1px 2px 0 rgba(0, 0, 0, .06);
    }

    .card {
        position: relative;
        display: flex;
        flex-direction: column;
        min-width: 0;
        word-wrap: break-word;
        background-color: #fff;
        background-clip: border-box;
        border: 2 solid rgba(0, 0, 0, .125);
        border-radius: .25rem;
        
    }

    .card-body {
        flex: 1 1 auto;
        min-height: 1px;
        padding: 1rem;
    }

    .gutters-sm {
        margin-right: -8px;
        margin-left: -8px;
    }

    .gutters-sm>.col,
    .gutters-sm>[class*=col-] {
        padding-right: 8px;
        padding-left: 8px;
    }

    .mb-3,
    .my-3 {
        margin-bottom: 1rem !important;
    }

    .bg-gray-300 {
        background-color: #e2e8f0;
    }

    .h-100 {
        height: 100% !important;
    }

    .shadow-none {
        box-shadow: none !important;
    }

    .buttons {
        width: 100%;
        height: 40px;
        border: none;
        background-color: white;
        color: black;
        border: 2px;
        border-radius: 5px;
        margin-top: 10px;
        text-align: left;
    }
    .buttons:hover {
    background-color: rgb(240, 104, 104);
}
    /* breadcrums */

    .breadcrumbs {
        margin-top: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        font-size: 16px;
    }

    .breadcrumbs ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }

    .breadcrumbs li {
        display: inline;
    }

    .breadcrumbs li:not(:last-child):after {
        content: ' / ';
        margin: 0 5px;
    }

    .breadcrumbs a {
        text-decoration: none;
        color: #007bff;
    }

    .breadcrumbs a:hover {
        text-decoration: underline;
        color: #0056b3;
    }
    .custom-border {
    border: 1px solid #e3e3e3;
    border-radius: 10px;
}
.card-body {
    border: 1px solid;
}
.custom-btn {
        background-color: white;
        color: black;
        border: 1px solid;
    }
    .custom-btn:hover {
        background-color: rgb(240, 104, 104);
        
    }
   .edit-btn , .change-btn , .save-btn{
    background-color: white;
        color: black;
        border: 1px solid;
   }
   .save-btn:hover{
    background-color: rgb(99, 175, 97);
   }
   .edit-btn:hover {
        background-color: rgb(99, 175, 97);
        
    }
    .change-btn:hover{
        background-color: #797474;
    }
</style>


<div class="page-header  text-center" style="background-image: url('assets/images/page-header-bg.png'); width: 100%;">
    <div class="container">
        <h1 class="page-title text-white">My Account</h1>
    </div><!-- End .container -->
</div>

<div class="container">
    
    <div class="main-body">

        <div class="row gutters-sm" style="margin-top: 50px;">
            <div class="col-md-4 mb-3">
                <div class="cardborder">
                    <div class="card-body">
                        <div class="d-flex flex-column align-items-center text-center">
                            <img src="/assets/images/profile.jpg" >
                            <div class="mt-1">
                            
                               
                                <a href="/userProfile"><button class="buttons" style="background-color: rgb(240, 104, 104);">My Account <i style="margin-right: 5px;"class="fas fa-user"></i></button></a>
                                <a href="/orderHistory"><button class="buttons">Order History <i style="margin-right: 5px;"class="fas fa-cart-plus"></i></button></a>
                                <button class="buttons" onclick="location.href='/addresses'">Addresses <i class="fas fa-address-book" style="margin-right: 5px;"></i></button>
                                <a href="/wallet"><button class="buttons">Wallet <i class="fas fa-wallet" style="margin-right: 5px;"></i></button></a>
                                <a href="/coupons"><button class="buttons" >Coupons <i class="fas fa-tag" style="margin-right: 5px;"></i></button></a>
                                <a href="/logout"><button class="buttons">Logout <i class="fas fa-sign-out-alt" style="margin-right: 5px;"></i></button></a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-md-8">
                <div class="card mb-3">
                    
                    <div class="card-body">
                        <div>
                            <h4 style="text-align: center; margin-top: 20px;">My Account</h4>
                        </div>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0"> Name</h6>
                            </div>
                            <input id="NameInput" style="border: none;" type="text" value="<%=user.name%>" required readonly/>
                        </div> 
                        <hr>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Email</h6>
                            </div>
                            <input style="border: none;" type="text" value="<%=user.email%>" readonly/>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-sm-3">
                                <h6 class="mb-0">Mobile</h6>
                            </div>
                            <input id="mobileInput" style="border: none;" type="tel" pattern="[0-9]{10}" value="<%=user.mobile%>" readonly/>
                        </div>
                        <hr>
                        <div id="passwordFields" style="display: none;">
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">Old Password</h6>
                                </div>
                                <input id="oldPasswordInput" style="border: none;" type="password" required>
                                <span class="toggle-password" onclick="togglePassword('oldPasswordInput')">üëÅÔ∏è</span>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">New Password</h6>
                                </div>
                                <input id="newPasswordInput" style="border: none;" type="password" required>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">Confirm Password</h6>
                                </div>
                                <input id="confirmPasswordInput" style="border: none;" type="text" required>
                            </div>
                            <hr>
                            <button id="savePasswordBtn" class="btn save-btn" style="display: none;" onclick="savePasswordChanges()">Save Changes</button>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-sm-6 col-6"> <!-- This will take up 6 columns on small screens -->
                                <div style="color: black; margin-left: 10px;">
                                    <a id="editBtn" class="btn custom-btn" target="__blank">Edit</a>
                                    <button id="saveBtn" class="btn edit-btn" style="display: none;">Save</button>
                                </div>
                            </div>
                            <div class="col-sm-6 col-6"> <!-- This will take up 6 columns on small screens -->
                                <div style="color: black; margin-right: 10px; text-align: right;">
                                    <a id="changePasswordBtn" class="btn change-btn" target="__blank">Change Password</a>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    
    // ********** FOR EYE OPTION FUNCTIONALITY FOR OLD PASSWORD **********
    function togglePassword(inputId) {
        const passwordInput = document.getElementById(inputId);
        if (passwordInput.type === "password") {
            passwordInput.type = "text";
        } else {
            passwordInput.type = "password";
        }
    }

 
// ********** SHOW CHANGE PASSWORD OPTIONS **********
    $(document).ready(function () {
        $('#changePasswordBtn').click(function () {
            $('#passwordFields').toggle();


            if ($('#passwordFields').is(':visible')) {
                $('#changePasswordBtn').text('Cancel');
                $('#savePasswordBtn').show();
            } else {
                $('#changePasswordBtn').text('Change Password');
                $('#savePasswordBtn').hide();
            }
        });
    });

    function saveUserProfileChanges() {
         // ********** FOR SAVING PASSWORD CHANGES **********
    }

     // ********** FOR GETTING EDIT OPTION **********
    $(document).ready(function () {
        $('#editBtn').click(function () {
            var editMode = $(this).text() === 'Edit';

            if (editMode) {
                $(this).text('Cancel');
                $('#NameInput').prop('readonly', false);
                $('#mobileInput').prop('readonly', false);
                $('#saveBtn').show();
                $('#NameInput').focus();
            } else {
                $(this).text('Edit');
                $('#NameInput').prop('readonly', true);
                $('#mobileInput').prop('readonly', true);
                $('#saveBtn').hide();
            }
        });

        // ********** FOR SAVING EDITED DETAILS WITH VALIDATION **********
        $('#saveBtn').click(function () {
            var userId = '<%= user._id%>';
            var newName = $('#NameInput').val();
            var newMobile = $('#mobileInput').val();

            if(!/^[A-Za-z\s]+$/.test(newName)){
                Swal.fire({
                    icon:'error',
                    title:'Error',
                    text:'Name Can Only Contain Alphabets'
                })
                return false;
            }
            if(!/^\d{10}$/.test(newMobile)){
                Swal.fire({ 
                    icon:'error',
                    title:'error',
                    text:'Mobile Number should contain 10 Digits'
                })
                return false;
            }
            fetch('/editUserProfile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId : userId,
                    newName: newName,
                    newMobile: newMobile
                })
            })
            .then(response => response.json()) 
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: data.message 
                    });

                    $('#editBtn').text('Edit');
                    $('#NameInput').prop('readonly', true);
                    $('#mobileInput').prop('readonly', true);
                    $('#saveBtn').hide();
                } else {
                    throw new Error('Failed to update user details');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Failed to update profile. Please try again.'
                });
            });
        });
    });

    // ********** FOR SAVING PASSWORDS WITH VALIDATION **********
    function savePasswordChanges() {
        var oldPassword = $('#oldPasswordInput').val();
        var newPassword = $('#newPasswordInput').val();
        var confirmPassword = $('#confirmPasswordInput').val();
        if(newPassword===oldPassword){
            Swal.fire({
                icon:'error',
                title : 'error',
                text : 'Old Password and New Password Cannot be Same'
            });
            return;
        }
        if (newPassword !== confirmPassword) {
            Swal.fire({ 
                icon: 'error',
                title: 'error',
                text: 'Confirm Password not matching'
            });
            return;
        }

        fetch('/editUserPassword', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                oldPassword: oldPassword,
                newPassword: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'success',
                    text: 'Password Update is Successfuly'
                });

                $('#oldPasswordInput').val('');
                $('#newPasswordInput').val('');
                $('#confirmPasswordInput').val('');
                $('#passwordFields').hide();
                $('#changePasswordBtn').text('Change Password'); 
                $('#savePasswordBtn').hide();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'error',
                    text: 'Old Password is incorrect'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<%-include('../layouts/footbar.ejs')%>
<%-include('../layouts/footer.ejs')%>   
