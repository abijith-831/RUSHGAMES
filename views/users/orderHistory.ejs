<%-include('../layouts/header.ejs')%>
<%-include('../layouts/navbar.ejs')%>


<style>
  .gradient-custom {
    background-image: url("/assets/images/backgrounds/login-bg.jp");
  }
  body {
    color: #1a202c;
    text-align: left;
  }

  .card {
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  }

  .card {
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
    word-wrap: break-word;
    background-color: #fff;
    background-clip: border-box;
    border: 2 solid rgba(0, 0, 0, 0.125);
    border-radius: 0.25rem;
  }

  .card-body {
    flex: 1 1 auto;
    min-height: 1px;
    padding: 1rem;
  }

  .gutters-sm {
    margin-right: -8px;
    margin-left: -8px;
  }

  .gutters-sm > .col,
  .gutters-sm > [class*="col-"] {
    padding-right: 8px;
    padding-left: 8px;
  }

  .mb-3,
  .my-3 {
    margin-bottom: 1rem !important;
  }

  .bg-gray-300 {
    background-color: #e2e8f0;
  }

  .h-100 {
    height: 100% !important;
  }

  .shadow-none {
    box-shadow: none !important;
  }

  .buttons {
    width: 100%;
    height: 40px;
    border: none;
    background-color: white;
    color: black;
    border: 2px;
    border-radius: 5px;
    margin-top: 10px;
    text-align: left;
  }
  .buttons:hover {
    background-color: rgb(240, 104, 104);
  }
  /* breadcrums */

  .breadcrumbs {
    margin-top: 20px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    font-size: 16px;
  }
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 0.85rem 1.5rem;
    font-weight: 400;
    font-size: 1.4rem;
    line-height: 1.5;
    letter-spacing: -0.01em;
    min-width: 137px;
    border-radius: 0;
    white-space: normal;
    transition: all 0.3s;
  }
  .breadcrumbs ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
  }

  .breadcrumbs li {
    display: inline;
  }

  .breadcrumbs li:not(:last-child):after {
    content: " / ";
    margin: 0 5px;
  }

  .breadcrumbs a {
    text-decoration: none;
    color: #007bff;
  }

  .breadcrumbs a:hover {
    text-decoration: underline;
    color: #0056b3;
  }
  .custom-border {
    border: 1px solid #e3e3e3;
    border-radius: 10px;
  }
  .card-body {
    border: 1px solid;
  }
  .custom-btn {
    background-color: white;
    color: black;
    border: 1px solid;
  }
  .custom-btn:hover {
    background-color: rgb(240, 104, 104);
  }
  .edit-btn,
  .change-btn,
  .save-btn {
    background-color: white;
    color: black;
    border: 1px solid;
  }
  .save-btn:hover {
    background-color: rgb(99, 175, 97);
  }
  .edit-btn:hover {
    background-color: rgb(99, 175, 97);
  }
  .change-btn:hover {
    background-color: #797474;
  }
</style>


<div
  class="page-header text-center"
  style="background-image: url('assets/images/page-header-bg.png'); width: 100%"
>
  <div class="container">
    <h1 class="page-title text-white">Order History</h1>
  </div>
  <!-- End .container -->
</div>

<div class="container-fluid">
  <div class="main-body">
    <div class="row gutters-sm" style="margin-top: 50px">
      <div class="col-md-3 mb-3">
        <div class="cardborder">
          <div class="card-body">
            <div class="d-flex flex-column align-items-center text-center">
              <img src="/assets/images/profile.jpg" />
              <div class="mt-1">
                <button class="buttons" onclick="location.href='/userProfile'">
                  My Account
                  <i class="fas fa-user" style="margin-right: 5px"></i>
                </button>
                <a href="/orderHistory"
                  ><button
                    class="buttons"
                    style="background-color: rgb(240, 104, 104)"
                  >
                    Order History
                    <i
                      style="margin-right: 5px"
                      class="fas fa-cart-plus"
                    ></i></button
                ></a>
                <button class="buttons" onclick="location.href='/addresses'">
                  Addresses
                  <i class="fas fa-address-book" style="margin-right: 5px"></i>
                </button>
                <button class="buttons">
                  Wallet <i class="fas fa-wallet" style="margin-right: 5px"></i>
                </button>
                <button class="buttons">
                  Offers <i class="fas fa-tag" style="margin-right: 5px"></i>
                </button>
                <a href="/logout"
                  ><button class="buttons">
                    Logout
                    <i
                      class="fas fa-sign-out-alt"
                      style="margin-right: 5px"
                    ></i></button
                ></a>
              </div>
            </div>
          </div>
        </div>
      </div>


      <div class="col-md-8 ml-5">
        <div class="row d-flex justify-content-center align-items-center">
            <div class="col-lg-12 col-xl-12">
                <div class="card" style="border-radius: 10px">
                    <div class="card-body p-4">
                        <% if (order.length === 0) { %> 
                            <h4 class="text-center">You haven't Ordered Anything yet!</h4>
                        <% } else { %>
                            <% order.forEach((orderItem ,  index) => { %>
                                <div class="card shadow-0 border mb-4">
                                    <div class="card-body">
                                        <div class="row">
                                            <% orderItem.games.forEach((game, index) => { %>
                                              
                                                <div class="col-md-3 mt-1">
                                                    <img src="<%= game.gameId.mainImage[0].path %>" class=" " style="height: 75px; width: 75px" alt="<%= game.gameId.name %>" />
                                                </div>
                                                <% if (game.Status==='Cancelled') { %>
                                                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                                                        <p class="text-muted mb-0" style="text-decoration: line-through;"><%= game.gameId.name %></p>
                                                    </div>
                                                <%  }else { %>
                                                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                                                      <p class="text-muted mb-0"><%= game.gameId.name %></p>
                                                    </div>
                                                <%   }  %> 
                                                <% if (game.Status==='Cancelled') { %> 
                                                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                                                        <p class="text-muted mb-0 small" style="text-decoration: line-through;">Qty: <%= game.quantity %></p>
                                                    </div>
                                                <%  }else { %> 
                                                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                                                      <p class="text-muted mb-0 small" >Qty: <%= game.quantity %></p>
                                                    </div>
                                                <%   }  %>    
                                                <% if (game.Status==='Cancelled') { %> 
                                                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                                                        <p class="text-muted mb-0 small" style="text-decoration: line-through;"><%= game.totalAmount %></p>
                                                    </div>
                                                <%  }else { %> 
                                                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                                                      <p class="text-muted mb-0 small"><%= game.totalAmount %></p>
                                                    </div>
                                                <%   }  %>  
                                                <% if (game.Status==='Cancelled') { %>    
                                                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                                                        <p class="text-muted mb-0" style="font-weight: bold; text-decoration: line-through;" ><%= orderItem.paymentMethod %></p>
                                                    </div>
                                                <%  }else { %> 
                                                    <div class="col-md-2 text-center d-flex justify-content-center align-items-center">
                                                      <p class="text-muted mb-0" style="font-weight: bold;"><%= orderItem.paymentMethod %></p>
                                                    </div>
                                                <%   }  %> 
                                            <% }) %>
                                        </div> 
                                        <div class="row mt-3" style="font-weight: bold;">
                                          <% if (orderItem.discount) { %>
                                              <% const discountedPrice = orderItem.totalCartPrice - (orderItem.totalCartPrice * orderItem.discount/100) %>
                                              <div class="col-md-3">
                                                <p class="text-muted mb-0" style="font-weight: bold;">Total Price: <%= discountedPrice %></p>
                                              </div>
                                          <% }else { %>
                                              <div class="col-md-3">
                                                <p class="text-muted mb-0" style="font-weight: bold;">Total Price: <%= orderItem.totalCartPrice %></p>
                                              </div>
                                          <% } %> 
                                          
                                          
                                            
                                            <div class="col-md-3">
                                              
                                                <p class="text-muted mb-0" style="font-weight: bold;">
                                                  Ordered Date: <%= new Date(orderItem.orderDate).toLocaleString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true }) %></p>
                                            </div>
                                            <div class="col-md-3">
                                                <button class="btn btn-primary" onclick="showOrderDetailsPage('<%= orderItem.orderId%>')">Order Details</button>
                                            </div>
                                            
                                            <% if(orderItem.paymentStatus !=='Success') { %>
                                              <div class="col-md-3">
                                                <button class="btn btn-info" >Re-Payment</button>
                                              </div>
                                            <% }else { %>
                                              <p style="font-weight: bold; color: green;">Payment    Success</p>
                                            <% } %>
                                            
                                                
                                            
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
      
    </div>
  </div>
</div> 


<!--  pass orderId to backend / loadorderDetailsPage -->
<script>
function showOrderDetailsPage(orderId) {
  const url = `/orderDetailsPage?orderId=${orderId}`;
  window.location.href = url;
}
</script>
	


<script>
	document.addEventListener('DOMContentLoaded', () => {
		// Existing proceedToCheckout function
		function proceedToCheckout(paymentMethod, addressId , couponId = null) {
			const requestBody = {
				paymentMethod : paymentMethod,
				addressId : addressId
			}

			if(couponId){
				requestBody.couponId = couponId;
			}
			fetch('/placeOrder', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(requestBody)
				
			})
				.then(response => response.json())
				.then(data => {
					if (data.success) {	
						if(data.couponCode){
							confetti({
								particleCount: 100,
								spread: 70,
								origin: { y: 0.6 }
							});
						}else{
							Swal.fire({
								icon: 'success',
								title: 'Success!',
								text: 'Order Placed Successfully .! ',
								showConfirmButton: false,
								timer: 1500
							})
							setTimeout(() => {
								window.location.href = '/orderHistory';
							}, 2000);
						}
					}else if(data.message==='nocod'){
						Swal.fire({
								icon : 'error',
								title : 'Not Available',
								text : 'Cash on Delivery not Available for Purchases Below 1000 Rs',
								confirmButtonText : 'OK'
						});
					} else if(data.Razorpay){
						const options = {
							"key": 'rzp_test_v7eXLfL0Wt6Ws9', 
							"amount": data.Razorpay.amount, 
							"currency": "INR",
							"name": "Rush Games",
							"description": "Test Transaction",
							"image": "https://example.com/your_logo",
							"order_id": data.Razorpay.id,
							"handler": function (response){
								verifyPayment(response, data.Razorpay)
							},
							"prefill": {
								"name": "Abhijith",
								"email": "abhijithasokan831gmail.com",
								"contact": "1234567890"
							},
							"notes": {
								"address": "Razorpay Corporate Office"
							},
							"theme": {
								"color": "#3399cc"
							}
						};
						var rzp1 = new Razorpay(options);
						rzp1.open();
					} else if(data.message == "nowallet"){
						Swal.fire({
							icon : 'error',
							title : 'No Wallet',
							text : 'You dont have wallet to Purchase',
							confirmButtonText : 'OK'
						});
					} else if(data.message == "Insufficient"){
						Swal.fire({
							icon : 'error',
							title : 'Insufficient Balance',
							text : 'You dont have enough balance in your Wallet',
							confirmButtonText : 'OK'
						});
					} else {
						Swal.fire({
							title: 'Order Processing Failed',
							text: 'An error occurred while processing the order.',
							icon: 'error',
							confirmButtonText: 'OK'
						});
					}
				})
				.catch(error => {
					console.error('Fetch error:', error);
				});
		}

		// Event listener for the order form
		document.querySelector('#orderForm').addEventListener('submit', (event) => {
			event.preventDefault();
			const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
			const selectedAddress = document.querySelector('input[name="address"]:checked').value;
			const couponInput = document.getElementById('checkout-discount-input');
			const couponId = couponInput ? couponInput.value : null;

			proceedToCheckout(paymentMethod, selectedAddress, couponId);
		});

		// Re-Payment button click handler
		document.querySelectorAll('.repayment-btn').forEach(button => {
			button.addEventListener('click', (event) => {
				const orderId = button.getAttribute('data-order-id');
				fetch(`/initiateRePayment/${orderId}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					}
				})
					.then(response => response.json())
					.then(data => {
						if (data.Razorpay) {
							const options = {
								"key": 'rzp_test_v7eXLfL0Wt6Ws9',
								"amount": data.Razorpay.amount,
								"currency": "INR",
								"name": "Rush Games",
								"description": "Test Transaction",
								"image": "https://example.com/your_logo",
								"order_id": data.Razorpay.id,
								"handler": function (response){
									verifyPayment(response, data.Razorpay)
								},
								"prefill": {
									"name": "Abhijith",
									"email": "abhijithasokan831gmail.com",
									"contact": "1234567890"
								},
								"notes": {
									"address": "Razorpay Corporate Office"
								},
								"theme": {
									"color": "#3399cc"
								}
							};
							var rzp1 = new Razorpay(options);
							rzp1.open();
						} else {
							Swal.fire({
								title: 'Re-Payment Initiation Failed',
								text: 'An error occurred while initiating the payment.',
								icon: 'error',
								confirmButtonText: 'OK'
							});
						}
					})
					.catch(error => {
						console.error('Fetch error:', error);
					});
			});
		});
	});

	function verifyPayment(payment, order){
		$.ajax({
			url: '/verifyPayment',
			data: JSON.stringify({
				payment,
				order
			}),
			contentType: 'application/json',
			method: 'POST',
			success: (response) => {
				if (response.success) {
					Swal.fire({
						title: 'Order Placed Successfully!',
						icon: 'success',
						showConfirmButton: false,
						timer: 2000
					});
					setTimeout(() => {
						window.location.href = '/orderHistory';
					}, 3000);
				} else {
					Swal.fire({
						title: 'Payment Failed',
						text: response.message || 'Your payment failed. Please try again.',
						icon: 'error',
						confirmButtonText: 'OK'
					}).then(() => {
						window.location.href = '/paymentFailed';
					});
				}
			},
			error: (error) => {
				console.error('Error verifying payment:', error);
			}
		});
	}
</script>


<%-include('../layouts/footbar.ejs')%> 
<%-include('../layouts/footer.ejs')%>
