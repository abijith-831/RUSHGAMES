<%-include('../layouts/header.ejs')%>
<%-include('../layouts/navbar.ejs')%>
<style>
    /* Add this CSS to give a black border to the content containers */
.content-container {
    border: 2px solid black;
    padding: 20px;
    margin-bottom: 20px;
}
/* Add thicker and bold bottom border after each product row */
.table-cart tbody tr {
    border-bottom: 2px solid black;
}
 

</style>

        <main class="main">
        	<div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.png')">
        		<div class="container">
        			<h1 class="page-title" style="color: white;"> Cart</h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item"><a href="#">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->
						
            <div class="page-content">
            	<div class="cart">
	                <div class="container-fluid">
	                	<div class="row">
	                		<div class="col-lg-9 content-container">
	                			<table class="table table-cart table-mobile">
									<thead >
										<tr style="color: black; font-weight: bold;">
											<th style="font-weight: bold; color: black">Product</th>
                                            <th style="font-weight: bold; color: black">Price</th>
                                            <th style="font-weight: bold; color: black">Quantity</th>
                                            <th style="font-weight: bold; color: black">Total</th>
                                            <th style="font-weight: bold; color: black"></th>

										</tr>
									</thead>

									<tbody> 
										
									<% if (cartData && cartData.gameId && cartData.length > 0) { %>  	
										<% cartData.forEach(gameItem => { %>
											
												<tr>
													<td class="product-col">
														<div class="product">
															<figure class="product-media">

																<a href="#">
																	<img src="" alt="<%= gameItem.game.name %>">
																</a>
															</figure>

															<h3 class="product-title">
																<a href="#"><%= gameItem.gameId.name %></a>
															</h3>
															
														</div><!-- End .product -->
													</td>
													<td class="price-col"><%= gameItem.gameId.price %></td>
													<td class="quantity-col">
														<div class="cart-product-quantity">

															<input type="number" oninput="cartUpdate(this,'<%= gameItem.gameId.price %>','<%= gameItem.gameId._id %>','<%= locals.cartData._id%>')"  class="form-control" value="<%= gameItem.quantity %>" min="1" max='<%= gameItem.gameId.stock  %>' step="1" data-decimals="0" required>
		
														</div>
													</td>
					
													<td class="total-col" style="color: black; font-weight: bold;"><%= gameItem.quantity * gameItem.gameId.price %></td>
													<td class="remove-col">
														<button class="btn-remove" style="color: black;" onclick="confirmDelete('<%= gameItem.gameId.name %>', '<%= gameItem.gameId._id %>')">
															<i class="icon-close"></i>
														</button>
													</td>
													
												</tr>
												
											
										<%	}) %>
										<% } else { %>
											<tr>
												<td colspan="5">Your cart is empty.</td>
											</tr>
										<% } %>
												
										
									</tbody>
								</table><!-- End .table table-wishlist -->

	                			<div class="cart-bottom">
			            			<div class="cart-discount">
			            				<form action="#">
			            					<div class="input-group">
				        						<input type="text" class="form-control" required placeholder="coupon code">
				        						<div class="input-group-append">
													<button class="btn btn-outline-primary-2" type="submit"><i class="icon-long-arrow-right"></i></button>
												</div><!-- .End .input-group-append -->
			        						</div><!-- End .input-group -->
			            				</form>
			            			</div><!-- End .cart-discount -->

			            			<a href="#" class="btn btn-outline-dark-2"><span>UPDATE CART</span><i class="icon-refresh"></i></a>
		            			</div><!-- End .cart-bottom -->
	                		</div><!-- End .col-lg-9 -->
	                		<aside class="col-lg-2.9 ml-5  content-container">
	                			<div class="summary summary-cart">
	                				<h3 class="summary-title">Cart Total</h3><!-- End .summary-title -->

	                				<table class="table table-summary">
	                					<tbody>
	                						<tr class="summary-subtotal">
	                							<td>Subtotal:</td>
	                							<td><%= totalCartPrice.toFixed(2) %> Rs</td>
	                						</tr><!-- End .summary-subtotal -->
	                						<tr class="summary-shipping">
	                							<td>Shipping:</td>
	                							<td>&nbsp;</td>
	                						</tr>

	                						<tr class="summary-shipping-row">
	                							<td>
													<div class="custom-control custom-radio">
														<input type="radio" id="free-shipping" name="shipping" class="custom-control-input">
														<label class="custom-control-label" for="free-shipping">Free Shipping</label>
													</div><!-- End .custom-control -->
	                							</td>
	                							<td>$0.00</td>
	                						</tr><!-- End .summary-shipping-row -->

	                						<tr class="summary-shipping-row">
	                							<td>
	                								<div class="custom-control custom-radio">
														<input type="radio" id="standart-shipping" name="shipping" class="custom-control-input">
														<label class="custom-control-label" for="standart-shipping">Standart:</label>
													</div><!-- End .custom-control -->
	                							</td>
	                							<td>$10.00</td>
	                						</tr><!-- End .summary-shipping-row -->

	                						<tr class="summary-shipping-row">
	                							<td>
	                								<div class="custom-control custom-radio">
														<input type="radio" id="express-shipping" name="shipping" class="custom-control-input">
														<label class="custom-control-label" for="express-shipping">Express:</label>
													</div><!-- End .custom-control -->
	                							</td>
	                							<td>20.00</td>
	                						</tr><!-- End .summary-shipping-row -->

	                						<tr class="summary-shipping-estimate">
	                							<td>Estimate for Your Country<br> <a href="dashboard.html">Change address</a></td>
	                							<td>&nbsp;</td>
	                						</tr><!-- End .summary-shipping-estimate -->

	                						<tr class="summary-total">
	                							<td>Total:</td>
	                							<td><%= totalCartPrice.toFixed(2) %> Rs</td>
	                						</tr><!-- End .summary-total -->
	                					</tbody>
	                				</table><!-- End .table table-summary -->

	                				<a href="/checkOut" class="btn btn-outline-dark btn-order btn-block" style="border-width: 2px; font-weight: bold;">PROCEED TO CHECKOUT</a>
	                			</div><!-- End .summary -->

		            			<a href="" class="btn btn-outline-dark btn-block mb-3" style="border-width: 2px; font-weight: bold;"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
	                		</aside><!-- End .col-lg-3 -->
	                	</div><!-- End .row -->
	                </div><!-- End .container -->
                </div><!-- End .cart -->
            </div><!-- End .page-content -->
</main><!-- End .main -->



<!--  Ask for confirmation for deleting  using SweetAlert -->
<script>
	function confirmDelete(gameName , gameId){
	// console.log(gameName);
	
    Swal.fire({
        title: "Are you sure?",
        text: 'You Sure you want to remove this from cart ? ',
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!",
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/removeFromCart?gameName=${gameName}&gameId=${gameId}`, { method: 'PUT' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: "Cart Deleted",
                            text: "Cart Deleted Successfully",
                            icon: "success"
                        }).then(() => {
                            window.location.reload();
                        });
                        $('#main-id').load('/cart #main-id');
                    } else {
                        Swal.fire({
                            title: "Error",
                            text: "An error occurred while deleting the cart.",
                            icon: "error"
                        }).then(() => {
                            window.location.reload();
                        });
						
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: "Error",
                        text: "An error occurred while processing your request.",
                        icon: "error"
                    });
                });
        }
    });
}
</script>



<!-- fucntion to  increase the amount when quantity changes -->
<script>
	function cartUpdate(input, price, gameId, cartId) {
    var quantity = input.value;
    var totalPrice = parseFloat(price) * parseInt(quantity);
    var totalCol = input.parentElement.parentElement.nextElementSibling;
    totalCol.textContent = totalPrice.toFixed(2); 
	var xhr = new XMLHttpRequest();
    xhr.open("POST", "/updateCartQuantity", true); // Adjust the URL and method as per your backend
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            // Handle the response if needed
            updateCartTotal();
        }
    };
    var data = JSON.stringify({ gameId: gameId, cartId: cartId, quantity: quantity });
    xhr.send(data);
}

function updateCartTotal() {
    var subtotal = 0;
    var total = 0;
    var totalCols = document.querySelectorAll('.total-col');
    totalCols.forEach(function(col) {
        subtotal += parseFloat(col.textContent);
    });
    var subtotalElement = document.getElementById('sub-total');
    if (subtotalElement) {
        subtotalElement.textContent = '$' + subtotal.toFixed(2);
    }
total = subtotal;
    var totalElement = document.getElementById('total');
    if (totalElement) {
        totalElement.textContent = '$' + total.toFixed(2);
    }
    var cartTotalElement = document.getElementById('cart-total');
    if (cartTotalElement) {
        cartTotalElement.textContent = total.toFixed(2);
    }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<%-include('../layouts/footbar.ejs')%>
<%-include('../layouts/footer.ejs')%>   