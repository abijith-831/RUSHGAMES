<%-include('../layouts/header.ejs')%>
<%-include('../layouts/navbar.ejs')%>


<style>
@import url('https://fonts.googleapis.com/css?family=Montserrat:400,700,500&display=swap');

.card {
    background-color: #413f3f;
}

p {
    margin: 0px;
}

.h8 {
    font-size: 25px;
    font-weight: 600;
    color: white;
}

.card .atm {
    width: 90px;
    height: 90px;
    object-fit: cover;
}

.card .visa {
    width: 50px;
    height: 20px;
    object-fit: fill;
}

.card .master {
    width: 50px;
    height: 50px;
    object-fit: fill;
}

.debit-card {
    width: 100%;
    height: 312px;
    padding: 20px;
    background-color: #52636d;
    background-image: linear-gradient(160deg, #0093E9 0%, #80D0C7 100%);
    position: relative;
    border-radius: 5px;
    box-shadow: 3px 3px 5px #0000001a;
    transition: all 0.3s ease-in;
    cursor: pointer;
}

.debit-card:hover {
    box-shadow: 5px 3px 5px #000000a2;
}



.text-muted {
    font-size: 0.8rem;
}

.text-white {
    font-size: 14px;
}

.input {
    position: absolute;
    top: 6px;
    right: 0;
}





      .gradient-custom {
        background-image: url("/assets/images/backgrounds/login-bg.jp");
      }

      body {
        color: #1a202c;
        text-align: left;
      }

      .card {
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      .card {
        position: relative;
        display: flex;
        flex-direction: column;
        min-width: 0;
        word-wrap: break-word;
        background-color: #fff;
        background-clip: border-box;
        border: 2 solid rgba(0, 0, 0, 0.125);
        border-radius: 0.25rem;
      }

      .card-body {
        flex: 1 1 auto;
        min-height: 1px;
        padding: 1rem;
      }

      .gutters-sm {
        margin-right: -8px;
        margin-left: -8px;
      }

      .gutters-sm>.col,
      .gutters-sm>[class*="col-"] {
        padding-right: 8px;
        padding-left: 8px;
      }

      .mb-3,
      .my-3 {
        margin-bottom: 1rem !important;
      }

      .bg-gray-300 {
        background-color: #e2e8f0;
      }

      .h-100 {
        height: 100% !important;
      }

      .shadow-none {
        box-shadow: none !important;
      }

      .buttons {
        width: 100%;
        height: 40px;
        border: none;
        background-color: white;
        color: black;
        border: 2px;
        border-radius: 5px;
        margin-top: 10px;
        text-align: left;
      }

      .buttons:hover {
        background-color: rgb(240, 104, 104);
      }

      .custom-border {
        border: 1px solid #e3e3e3;
        border-radius: 10px;
      }

      .card-body {
        border: 1px solid;
      }

     
      .edit-btn,
      .change-btn,
      .save-btn {
        background-color: white;
        color: black;
        border: 1px solid;
      }
      .button-group {
  display: flex;
  gap : 30px;
  margin-top: 10px;
}

.button-group .btn {
  flex: 1;
  margin-right: 10px;
}

.button-group .btn:last-child {
  margin-right: 0; 
}

</style>


<div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.png'); width: 100%">
      <div class="container">
        <h1 class="page-title text-white">Wallet</h1>
      </div>
      <!-- End .container -->
</div>

<div class="container" >
      <div class="main-body">
        <div class="row gutters-sm" style="margin-top: 50px">
          <div class="col-md-3 mb-3">
            <div class="cardborder">
              <div class="card-body">
                <div class="d-flex flex-column align-items-center text-center">
                  <img src="/assets/images/profile.jpg" />
                  <div class="mt-1">
                    <button class="buttons" onclick="location.href='/userProfile'">
                      My Account
                      <i class="fas fa-user" style="margin-right: 5px"></i>
                    </button>
                    <a href="/orderHistory">
                      <button class="buttons">
                        Order History<i style="margin-right: 5px" class="fas fa-cart-plus"></i>
                      </button>
                    </a>
                    <button class="buttons" onclick="location.href='/addresses'">
                      Addresses
                      <i class="fas fa-address-book" style="margin-right: 5px"></i>
                    </button>
                    <button class="buttons" style="background-color: rgb(240, 104, 104)">
                      Wallet <i class="fas fa-wallet" style="margin-right: 5px"></i>
                    </button>
                    <a href="/coupons"><button class="buttons" >Coupons <i class="fas fa-tag" style="margin-right: 5px;"></i></button></a>

                    <a href="/logout">
                      <button class="buttons">
                        Logout
                        <i class="fas fa-sign-out-alt" style="margin-right: 5px"></i>
                      </button>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card mb-3">
              <div class="card-body">
                <div class="row">
                  <div class="col-sm-12">                               
                    <div class="wrapper">
                      <div class="card ">
                        <br>
                        <div class="debit-card">
                          <div class="d-flex flex-column h-100">
                            <label class="d-block">
                              <div class="d-flex position-relative">
                                <div>
                                  
                                  <% if (wallet) { %>
                                    <h4 class="mt-2 mb-4 text-white fw-bold"><%= user.name %></h4>
                                  <% } %>
                                  <h4 class="mt-2 mb-4 text-white fw-bold"></h4>
                                </div>
                                <div class="input">
                                  <h5>Balance</h5>
                                  <% if (wallet) { %>
                                    <h5>â‚¹  <%= Math.floor(wallet.balance) %> </h5>
                                  <%  }else{ %>
                                    <h5>Empty</h5>
                                  <% } %>
                                  
                                </div>
                              </div>
                            </label>
                            <div class="mt-auto fw-bold d-flex align-items-center justify-content-between">
                              <p>XXXX-XXXX-XXXX</p>
                              <p>01/24</p>
                            </div>
                          </div>
                        </div>
                        <br>

                        <% if (wallet) { %>
                          <div class="row align-items-center">
                            <div class="col-md-4 col-6 mb-3">
                              <a class="btn change-btn" style="background-color: rgb(102, 212, 111)" data-toggle="modal" data-target="#addMoneyModal">+ ADD MONEY</a>
                            </div>
                            <div class="col-md-4 col-6 mb-3">
                              <a class="btn change-btn edit-address-btn" style="background-color: rgb(240, 104, 104)" data-toggle="modal" data-target="#withdrawMoneyModal">WITHDRAW</a>
                            </div>
                            <div class="col-md-4  col-12 d-flex justify-content-center  mb-3">
                              <a class="btn change-btn delete-address-btn"  data-toggle="modal" data-target="#transactionModal">TRANSACTIONS</a>
                            </div>
                          </div>
                       
                        <%  }else{ %>
                          <div class="button-group">
                            <a id="addMoneyBtn" class="btn change-btn" style="background-color: rgb(102, 212, 111)" data-toggle="modal" data-target="#addMoneyModal">+ ADD MONEY</a>
                            
                          </div>
                        <% } %>
                        
                      </div>
                      <br>
                    </div>  
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
</div>



<!----------- add money to wallet modal ------------------------------------ -->
<div class="modal fade" id="addMoneyModal" tabindex="-1" role="dialog" aria-labelledby="addMoneyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content  text-red px-5 mt-4 mb-4">
      <br>
      <div class="modal-header border-bottom-red">
        <h5 class="modal-title" style="text-align: center;" id="addMoneyModalLabel">Add Money To Wallet</h5>
        <button type="button" class="close text-red" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="walletForm" onclick="return validation()">
          <div class="form-group">
            <label for="amount">Amount</label>
            <input type="text" class="form-control" id="amount" placeholder="Enter the Amount you want to Add" required>
            <p id="amountError" style="color: red;"></p>
          </div>
          <div class="form-group">
            <label for="method" id="method">Payment Method</label>
            <select class="form-control" id="methodSelect">
              <option style="font-size: 16px; color: black;" value="googlepay">GOOGLE PAY</option>
              <option style="font-size: 16px; color: black;" value="phonepay">PHONE PAY</option>
              <option style="font-size: 16px; color: black;" value="paytm">PAY TM</option>
              <option style="font-size: 16px; color: black;" value="bharatpay">BHARAT PAY</option>
            </select>
          </div>
          <button type="submit"  class="btn btn-success btn-block" id="cancelAddMoney"  >ADD MONEY</button>
          <br><br>
        </form>
      </div>
    </div>
  </div>
</div>



<!-- Add money to wallet functionality -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('#cancelAddMoney').addEventListener('click', function(event) {
      event.preventDefault();
      if (validation()) {
        const amount = document.getElementById('amount').value;
        const method = document.getElementById('methodSelect').value;
        const formData = { amount, method };
  
        fetch('/addMoneyToWallet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: 'Money Added to Wallet successfully',
              showConfirmButton: false,
              timer: 1500
            })
            .then(() => {
                window.location.reload();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error!',
              text: 'An error occurred while processing your request.',
              confirmButtonText: 'OK'
            });
          }
          
          $('#addMoneyModal').modal('hide');
        })
        .catch(error => {
          console.log(error);
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'An error occurred while processing your request.',
            confirmButtonText: 'OK'
          });
          $('#addMoneyModal').modal('hide');
        });
      }
    });
  });
  </script>



<!--  ADD Amount validation -->
<script>
  function validation (){
    let amount = document.getElementById('amount').value.trim();
    // let amountRegex = /^(?:[1-9]\d{0,4}|50000)$/;
    let amountRegex = /^\d{3,6}(\.\d{1,2})?$/;
    let amountError = document.getElementById('amountError')
    amountError.innerText = ''
    if(amount ===''){
      amountError.innerText = "Amount Cannot be Empty"
      return false
    }else if(!amountRegex.test(amount)){
      amountError.innerText = "You need to enter a Valid Amount"
      return false;
    }else if(Number(amount)>50000){
      amountError.innerText = "You can Only add 50000 at a Time"
      return false;
    }
    return true;

  }
</script>



<!----------- withdraw money from wallet modal ------------------------------------ -->
<div class="modal fade" id="withdrawMoneyModal" tabindex="-1" role="dialog" aria-labelledby="withdrawMoneyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content  text-red px-5 mt-4 mb-4">
      <br>
      <div class="modal-header border-bottom-red">
        <h5 class="modal-title" style="text-align: center;" id="withdrawMoneyModalLabel">Withdraw Money From Wallet</h5>
        <button type="button" class="close text-red" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="walletForm1" onclick="return validation2()">
          <div class="form-group">
            <label for="amount2">Amount</label>
            <input type="text" class="form-control" id="amount2" placeholder="Enter the Amount you want to Withdraw" required>
            <p id="amount2Error" style="color: red;"></p>
          </div>
          
          <button type="submit"  class="btn btn-warning   btn-block" id="cancelwithdrawMoney"  >WITHDRAW MONEY</button>
          <br><br>
        </form>
      </div>
    </div>
  </div>
</div>



<!-- withdraw money from wallet functionality -->
<script>
  document.addEventListener('DOMContentLoaded',function(){
    document.querySelector('#cancelwithdrawMoney').addEventListener('click',function(event){
      event.preventDefault();
      if(validation2()){
        const amount = document.getElementById('amount2').value;
      // console.log('dasf'+amount);
      const formData = {amount}

      fetch('/withdrawMoney',{
        method : 'POST',
        headers : {
          "Content-Type" : 'application/json'
        },
        body : JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data =>{
          if(data.success){
            Swal.fire({
            icon : 'success',
            title: 'Success!',
            text: 'Money Withdrew from Wallet Successfully',
            showConfirmButton: false,
            timer: 1500
          })
          .then(() => {
              window.location.reload();
          });
        }else if(data.message === "Insufficient"){
          Swal.fire({
								icon : 'error',
								title : 'Insufficient Balance',
								text : 'You dont have enough balance in your Wallet',
								confirmButtonText : 'OK'
							});

      }else{
        Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: 'An error occurred while processing your request.',
            confirmButtonText: 'OK'
          });
      }
        
      })
      }
      
    })
  })
</script>



<!--  WITHDRAW Amount validation -->
<script>
  function validation2(){
    let amount2 = document.getElementById('amount2').value.trim();
    let amount2Regex = /^\d{3,6}(\.\d{1,2})?$/;
    let amount2Error = document.getElementById('amount2Error');
    amount2Error.innerText = '';
    if(amount2===''){
      amount2Error.innerText = "Amount Cannot be Empty"
      return false
    }else if(!amount2Regex.test(amount2)){
      amount2Error.innerText = "You need to enter a Valid Amount"
      return false
    }else if(Number(amount2)>50000){
      amount2Error.innerText = "You can Only Withdraw 50000 at a Time";
      return false
    }
    return true
  }
</script>



<!--  transaction modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" role="dialog" aria-labelledby="transactionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content  text-red px-5 mt-4 mb-4" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 80vw;">
      <br>
      <div class="modal-header border-bottom-red" >
        <div class="row">
            <h5 class="modal-title text-left" id="transactionModalLabel">Wallet Transactions</h5>
          </div>
        
        <button type="button" class="close text-red" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="background-color: white; padding: 20px; overflow-y: auto; max-height: calc(100vh - 300px);">
        <table class="table table-dark table-striped" style="color: black; background-color: white;">
          <thead>
            <tr>
              <th style="font-weight: bold;" scope="col">SL NO.</th>
              <th style="font-weight: bold;" scope="col">Amount</th>
              <th style="font-weight: bold;" scope="col">Date & Time</th>
              <th style="font-weight: bold;" scope="col">Payment Method</th>
              <th style="font-weight: bold;" scope="col">Status</th>
              <th style="font-weight: bold;" scope="col">Balance</th>
               
            </tr>
          </thead>
          <tbody>
            <% if (rev) { %>

              <% rev.forEach ((item , index) => { %> 
                <tr>
                  <th scope="row"><%= index+1 %></th>
                  <% if (item.transactionType === 'debit') { %>
                    <td>- â‚¹<%= Math.floor(item.amount) %></td>
                  <%  }else { %>
                    <td> â‚¹<%= Math.floor(item.amount) %></td>
                  <%  }  %>
                  
                  <td><%= new Date(item.date).toLocaleString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true }) %></td>
                  <td><%= item.method %></td>
                  <% if (item.transactionType === 'debit') { %>
                    <td style="color: red;"><%= item.transactionType %></td>
                  <%  }else { %>
                    <td style="color: green;"><%= item.transactionType %></td>
                  <%  }  %>
                  
                  <td>â‚¹ <%=Math.floor(item.currBalance) %></td>
                </tr>
  
              <%   })  %>
            <% } %>
            
          </tbody>
        </table>
      </div>
      <div class="row">
        <div class="col-lg-6">
          <% if (wallet) { %>
            <h5 class="text-right">Balance: â‚¹ <%= Math.floor(wallet.balance) %></h5>
          <% }else{ %>
            <h5 class="text-right">Balance:  </h5>
          <%  } %>
          
        </div>
      </div>
      <div class="modal-footer border-top-red">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close </button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>\
<script src="https://use.fontawesome.com/releases/v5.7.2/css/all.css"></script>



<%-include('../layouts/footbar.ejs')%>
<%-include('../layouts/footer.ejs')%>




      